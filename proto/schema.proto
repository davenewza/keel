syntax = "proto3";

package proto;

option go_package = "github.com/teamkeel/proto";

import "google/protobuf/wrappers.proto";

message Schema {
    repeated Model models = 1;
    repeated Role roles = 2;
    repeated Api apis = 3;
    repeated Enum enums = 4;
}

message Model {
    // The name of the model. Must be in PascalCase and be unique within the schema.
    string name = 1;

    // The fields this model contains
    repeated Field fields = 2;

    // The operations this model defines. Contains both operations that will be auto
    // generated and also custom functions
    repeated Operation operations = 3;

    repeated PermissionRule permissions = 4;
}

message Field {
    // The name of the model this field belongs to.
    string model_name = 1;

    // The name of the field. Must be in lowerCamelCase and be unique within the model.
    string name = 2;

    // Info regarding the type of this field
    TypeInfo type = 3;

    // If true then this field is allowed to be null
    bool optional = 4;

    // If true then this field will have a unique constraint added to it meaning
    // a given value can only exist in a single row.
    // Cannot be true if `type.repeated` is true
    bool unique = 5;

    // If true then this field will be set as the primary key for the parent model
    bool primary_key = 7;
}

message Operation {
    // The name of the model this operation belongs to.
    string model_name = 1;

    // The name of the operation. Must be in lowerCamelCase and be unique across all operations
    // across all models within the schema. This is because in both RPC and GraphQL operations
    // are top-level and so two different models can't both define an operation with the same name.
    string name = 2;

    // The type of this operation.
    OperationType type = 3;

    // Whether this operation will be auto-generated by Keel or implemented with a custom function.
    OperationImplementation implementation = 4;

    // The inputs this operation accepts.
    repeated OperationInput inputs = 5;

    // A list of permission rules to apply to this operation
    repeated PermissionRule permissions = 6;

    // A list of assignment expression to be executed as part of this operation.
    // Only valid in `type` is OPERATION_TYPE_CREATE or OPERATION_TYPE_UPDATE
    repeated Expression set_expressions = 7;

    // A list of logical expressions to be applied to the database query being
    // executed as part of the operation.
    // Not valid if `type` is OPERATION_TYPE_CREATE
    // If there are multiple entries in this field they are AND'd.
    repeated Expression where_expressions = 8;
}

message OperationInput {
    // Name of the parent model
    string model_name = 1;

    // Name of the parent operation
    string operation_name = 2;

    // Name of the input. Must be lowerCamelCase and unique within the parent operation.
    string name = 3;

    // The type of this input. 
    TypeInfo type = 4;

    // Set to true if this input field is optional
    bool optional = 6;

    // Indicates whether the input is used for reading or writing data
    InputMode mode = 7;

    // Indicates whether the behaviour of this input is handled by Keel
    // or if it is explicitly expressed in the schema
    InputBehaviour behaviour = 8;

    // If `behaviour` is INPUT_BEHAVIOUR_IMPLICIT then this field indicates the path to the
    // field (from the parent model) that should be filtered/updated.
    // As an example if the parent model had a field called `item` which was a relationship to
    // an `Item` model which itself had a field called `price`, and this input wanted to filter
    // on the item price, then the value of `target` would be ["item", "price"]
    repeated string target = 9;
}

enum InputMode {
    INPUT_MODE_UNKNOWN = 0;

    // Read inputs are used for filtering results in get, list, and update actions
    INPUT_MODE_READ = 1;

    // Write inputs are used to set fields on a model in a create or update action
    INPUT_MODE_WRITE = 2;
}

enum InputBehaviour {
    INPUT_BEHAVIOUR_UNKNOWN = 0;

    // Implicit behaviour means the input will be used automatically by Keel to either
    // filter the results or write data
    INPUT_BEHAVIOUR_IMPLICIT = 1;

    // Explicit behaviour means the input is used in one of the `set_expressions` or
    // `where_expressions` of the `Operation`
    INPUT_BEHAVIOUR_EXPLICIT = 2;
}

message Role {
    // The name of the role
    string name = 1;

    // A list of domains to match for this role e.g. myorg.com
    repeated string domains = 2;

    // A list of specific email addresses to match for this role eg. sarah@myorg.com
    repeated string emails = 3;
}

message PermissionRule {
    // Name of the model this permission rule applies to
    string model_name = 1;

    // Name of the specific operation this permission rule applies to.
    // If this field is populated then `operations_types` is ignored.
    google.protobuf.StringValue operation_name = 2;

    // A name of a Role that has been defined in the schema.
    // Cannot be provided if `expression` is provided.
    repeated string role_names = 3;

    // An expression to evaluate at runtime.
    // Cannot be provided if `role_name` is provided.
    Expression expression = 4;

    // A list of operation types that this permission rule applies to
    // Should not be set if `operation_name` is provided.
    repeated OperationType operations_types = 5;
}

message Expression {
    string source = 1;
}

message Api {
    string name = 1;
    ApiType type = 2;
    repeated ApiModel api_models = 3;
}

message ApiModel {
    string model_name = 1;
}

message Enum {
    string name = 1;
    repeated EnumValue values = 2;
}

message EnumValue {
    string name = 1;
}

message TypeInfo {
    // The type of the field.
    Type type = 1;

    // If `type` is set to TYPE_ENUM then this value is the name of the
    // the enum that the type refers to.
    google.protobuf.StringValue enum_name = 2;

    // If `type` is set to TYPE_MODEL then this value is the name of the
    // the model that the type refers to.
    google.protobuf.StringValue model_name = 3;

    // If true then is type is an array of it's `type`
    bool repeated = 4;
}

enum ApiType {
    API_TYPE_UNKNOWN = 0;
    API_TYPE_GRAPHQL = 1;
    API_TYPE_RPC = 2;
}

enum OperationInputType {
    OPERATION_INPUT_TYPE_UNKNOWN = 0;

    // Means the input maps directly to a field on a model
    OPERATION_INPUT_TYPE_FIELD = 1;

    OPERATION_INPUT_TYPE_STRING = 2;
    OPERATION_INPUT_TYPE_BOOL = 3;
    // etc...
}

enum OperationImplementation {
    OPERATION_IMPLEMENTATION_UNKNOWN = 0;

    // Auto means the implementation of the operation is generated by Keel.
    OPERATION_IMPLEMENTATION_AUTO = 1;

    // Custom means the implementation of the operation is provided via custom code.
    // The code itself is not represented in this proto schema. 
    OPERATION_IMPLEMENTATION_CUSTOM = 2;
}

enum OperationType {
    OPERATION_TYPE_UNKNOWN = 0;
    
    // Creates a new record and returns it
    OPERATION_TYPE_CREATE = 1;

    // Returns a single record by looking up on a unique field
    OPERATION_TYPE_GET = 2;

    // Lists records optionally filtering on certain fields. The response would be a
    // an object that supports pagination functionality and contains a "page" of results.
    OPERATION_TYPE_LIST = 3;

    // Update a single record by providing a unique lookup and some fields to update.
    // The resulting record is returned.
    OPERATION_TYPE_UPDATE = 4;

    // Delete a record and returns it's ID
    OPERATION_TYPE_DELETE = 5;
}

enum Type {
    TYPE_UNKNOWN = 0;
    TYPE_STRING = 1;
    TYPE_BOOL = 2;
    TYPE_INT = 3;
    TYPE_TIMESTAMP = 4;
    TYPE_DATE = 5;
    TYPE_ID = 6;
    TYPE_MODEL = 7;
    TYPE_CURRENCY = 8;
    TYPE_DATETIME = 9;
    TYPE_ENUM = 10;
    TYPE_IDENTITY = 11;
    TYPE_IMAGE = 12;
}